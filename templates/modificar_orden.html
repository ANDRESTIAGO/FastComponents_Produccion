{% extends 'base.html' %}
{% block content %}

<section id="hero">
    <div class="hero">
        <h1 class="hero-title">Modificar orden existente</h1>
        <h3 class="hero-subtitle">Aqu√≠ puedes modificar los componentes compatibles de tus √≥rdenes</h3>
    </div>
</section>

<section id="Lo-que-ofresemos">
    <div class="cards-container">
        <div class="form_forma">
            <form method="post" action="/modificar">
                <label>Selecciona la orden:</label>
                <select name="orden" id="orden" onchange="mostrarComponentes()" required>
                    <option value="">--Seleccionar--</option>
                    {% for nombre in ordenes %}
                        <option value="{{ nombre }}">{{ nombre }}</option>
                    {% endfor %}
                </select>

                <br><br><br>

                <label>Selecciona el componente que deseas reemplazar:</label>
                <br><br>
                <select name="componente_id_original" id="componente" onchange="mostrarCompatibles()" required>
                    <option value="">--Selecciona una orden primero--</option>
                </select>

                <br><br><br>

                <label>Selecciona el nuevo componente compatible:</label>
                <br><br>
                <select name="nuevo_id" id="nuevo" required>
                    <option value="">--Selecciona un componente primero--</option>
                </select>

                <br><br><br>
                <button type="submit">Aplicar cambio</button>
            </form>
        
            <form action="/menu#Como-ayudar">
                <button>Regresar</button>
            </form>
        </div>
    </div>
</section>

<script>
    //Datos enviados desde FastAPI
    const data = {{ componentes_por_orden | tojson }};

    // Al seleccionar una orden, se listan los componentes actuales
    function mostrarComponentes() {
        const orden = document.getElementById("orden").value;
        const selectComp = document.getElementById("componente");
        const selectNuevo = document.getElementById("nuevo");
        selectComp.innerHTML = "";
        selectNuevo.innerHTML = "<option value=''>--Selecciona un componente primero--</option>";

        if (orden && data[orden]) {
            const comps = data[orden].componentes_actuales;
            comps.forEach(c => {
                const option = document.createElement("option");
                option.value = c.id;
                option.text = `${c.tipo} - ${c.marca} ${c.modelo}`;
                if (c.tipo === "Motherboard") {
                    option.disabled = true; // üîí No se puede cambiar la placa madre
                    option.text += " (No modificable)";
                }
                selectComp.appendChild(option);
            });
        } else {
            const option = document.createElement("option");
            option.value = "";
            option.text = "--No hay componentes--";
            selectComp.appendChild(option);
        }
    }

    // Al seleccionar un componente, se muestran los reemplazos compatibles
    function mostrarCompatibles() {
        const orden = document.getElementById("orden").value;
        const compId = document.getElementById("componente").value;
        const selectNuevo = document.getElementById("nuevo");
        selectNuevo.innerHTML = "";

        if (!orden || !data[orden]) return;

        // Buscar el componente original y su tipo
        const comp = data[orden].componentes_actuales.find(c => c.id == compId);
        if (!comp) return;

        const tipo = comp.tipo;
        const compatibles = data[orden].compatibles[tipo] || [];

        if (compatibles.length > 0) {
            compatibles.forEach(c => {
                const option = document.createElement("option");
                option.value = c.id;
                option.text = `${c.marca} ${c.modelo}`;
                selectNuevo.appendChild(option);
            });
        } else {
            const option = document.createElement("option");
            option.value = "";
            option.text = "--No hay componentes compatibles--";
            selectNuevo.appendChild(option);
        }
    }
</script>

{% endblock %}
